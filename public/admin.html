<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –ü–∞—Ç–∏-–†–∞–π—Ö</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap');

        .imperial-font {
            font-family: 'Cinzel', serif;
        }

        .modern-font {
            font-family: 'Inter', sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #dc2626 0%, #7c2d12 100%);
        }

        .card-shadow {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .royal-border {
            border: 3px solid;
            border-image: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700) 1;
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="modern-font gradient-bg min-h-screen">
<div x-data="adminPanel()" x-init="init()" class="container mx-auto px-4 py-4 md:py-8">
    <!-- Header -->
    <div class="text-center mb-6 md:mb-8">
        <h1 class="imperial-font text-3xl md:text-5xl font-bold text-white mb-2 md:mb-4 drop-shadow-lg">
            ‚öîÔ∏è –ü–ê–ù–ï–õ–¨ PARTY KAISER ‚öîÔ∏è
        </h1>
        <p class="text-lg md:text-xl text-white/90 imperial-font">
            –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–µ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–∞—Ç–∏-–†–∞–π—Ö–æ–º
        </p>
        <p class="text-sm md:text-lg text-white/80 mt-2">
            –í–ª–∞—Å—Ç—å –Ω–∞–¥ —Ç–∏—Ç—É–ª–∞–º–∏ –∏ –ø–æ–¥–¥–∞–Ω–Ω—ã–º–∏
        </p>

        <!-- Navigation -->
        <div class="mt-4 md:mt-6 flex flex-wrap justify-center gap-2 md:gap-4">
            <a href="/"
               class="bg-white/20 text-white px-3 py-2 md:px-4 text-sm md:text-base rounded-lg hover:bg-white/30 transition-colors">
                üè∞ –ì–ª–∞–≤–Ω–∞—è
            </a>
            <a href="/profile"
               class="bg-white/20 text-white px-3 py-2 md:px-4 text-sm md:text-base rounded-lg hover:bg-white/30 transition-colors">
                üë§ –ü—Ä–æ—Ñ–∏–ª—å
            </a>
            <a href="/hall-of-fame"
               class="bg-white/20 text-white px-3 py-2 md:px-4 text-sm md:text-base rounded-lg hover:bg-white/30 transition-colors">
                üèÜ –ó–∞–ª –°–ª–∞–≤—ã
            </a>
        </div>
    </div>

    <!-- Access Denied (if not admin) -->
    <div x-show="!isAuthorized && !loading" class="max-w-md mx-auto bg-white rounded-2xl card-shadow overflow-hidden">
        <div class="bg-gradient-to-r from-red-600 to-red-800 p-6">
            <h2 class="imperial-font text-2xl md:text-3xl font-semibold text-white text-center">
                üö´ –î–æ—Å—Ç—É–ø –ó–∞–ø—Ä–µ—â—ë–Ω
            </h2>
        </div>
        <div class="p-6 md:p-8 text-center">
            <div class="text-5xl md:text-6xl mb-4">‚öîÔ∏è</div>
            <p class="text-lg md:text-xl text-gray-800 mb-6">
                –¢–æ–ª—å–∫–æ Party Kaiser –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —ç—Ç–æ–π –ø–∞–Ω–µ–ª–∏
            </p>
            <a href="/profile"
               class="bg-red-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-lg font-bold text-base md:text-lg hover:bg-red-700 transition-colors inline-block">
                –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ü—Ä–æ—Ñ–∏–ª—å
            </a>
        </div>
    </div>

    <!-- Loading -->
    <div x-show="loading" class="text-center py-12">
        <div class="inline-flex items-center text-white text-lg md:text-xl">
            <svg class="animate-spin h-6 w-6 md:h-8 md:w-8 mr-3" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"
                        fill="none"></circle>
                <path class="opacity-75" fill="currentColor"
                      d="m4 12a8 8 0 0 1 8-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 0 1 4 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            –ó–∞–≥—Ä—É–∑–∫–∞...
        </div>
    </div>

    <!-- Admin Content -->
    <div x-show="isAuthorized && !loading" class="max-w-7xl mx-auto space-y-6 md:space-y-8">

        <!-- Stats Overview -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-6">
            <div class="bg-white/90 backdrop-blur-sm rounded-xl p-4 md:p-6 text-center card-shadow">
                <div class="text-2xl md:text-4xl mb-1 md:mb-2">üë•</div>
                <div class="text-xl md:text-2xl font-bold text-gray-800" x-text="users.length"></div>
                <div class="text-xs md:text-base text-gray-600">–í—Å–µ–≥–æ</div>
            </div>
            <div class="bg-white/90 backdrop-blur-sm rounded-xl p-4 md:p-6 text-center card-shadow">
                <div class="text-2xl md:text-4xl mb-1 md:mb-2">üèÜ</div>
                <div class="text-xl md:text-2xl font-bold text-gray-800"
                     x-text="users.filter(u => u.oath_taken).length"></div>
                <div class="text-xs md:text-base text-gray-600">–ü–æ–¥–¥–∞–Ω–Ω—ã—Ö</div>
            </div>
            <div class="bg-white/90 backdrop-blur-sm rounded-xl p-4 md:p-6 text-center card-shadow">
                <div class="text-2xl md:text-4xl mb-1 md:mb-2">üëë</div>
                <div class="text-xl md:text-2xl font-bold text-gray-800"
                     x-text="users.filter(u => u.role === 'admin').length"></div>
                <div class="text-xs md:text-base text-gray-600">–ê–¥–º–∏–Ω–æ–≤</div>
            </div>
            <div class="bg-white/90 backdrop-blur-sm rounded-xl p-4 md:p-6 text-center card-shadow">
                <div class="text-2xl md:text-4xl mb-1 md:mb-2">üìú</div>
                <div class="text-xl md:text-2xl font-bold text-gray-800"
                     x-text="users.filter(u => u.title).length"></div>
                <div class="text-xs md:text-base text-gray-600">–¢–∏—Ç—É–ª–æ–≤</div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="bg-white rounded-2xl card-shadow p-4 md:p-6">
            <div class="flex flex-col md:flex-row gap-3 md:gap-4 items-stretch md:items-center">
                <div class="flex-1">
                    <input
                            x-model="searchTerm"
                            @input="filterUsers"
                            type="text"
                            placeholder="–ü–æ–∏—Å–∫..."
                            class="w-full px-3 md:px-4 py-2 md:py-3 text-sm md:text-base border-2 border-gray-300 rounded-lg focus:border-red-500 focus:outline-none transition-colors"
                    >
                </div>
                <div class="flex items-center gap-3 md:gap-4">
                    <select
                            x-model="filterRole"
                            @change="filterUsers"
                            class="flex-1 md:flex-none px-3 md:px-4 py-2 md:py-3 text-sm md:text-base border-2 border-gray-300 rounded-lg focus:border-red-500 focus:outline-none transition-colors"
                    >
                        <option value="all">–í—Å–µ —Ä–æ–ª–∏</option>
                        <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</option>
                        <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                    </select>
                    <span class="text-sm md:text-base text-gray-600 font-semibold whitespace-nowrap"
                          x-text="`${filteredUsers.length}`"></span>
                </div>
            </div>
        </div>

        <!-- Users Management -->
        <div class="bg-white rounded-2xl card-shadow overflow-hidden">
            <div class="bg-gradient-to-r from-red-600 to-red-800 p-4 md:p-6">
                <h2 class="imperial-font text-2xl md:text-3xl font-semibold text-white text-center">
                    üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–æ–¥–¥–∞–Ω–Ω—ã–º–∏
                </h2>
            </div>

            <!-- Desktop Table -->
            <div class="hidden md:block overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">–¢–∏—Ç—É–ª</th>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">–†–æ–ª—å</th>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                    </thead>
                    <tbody>
                    <template x-for="user in filteredUsers" :key="user.id">
                        <tr class="border-t border-gray-200 hover:bg-gray-50">
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <div>
                                        <div class="font-semibold text-gray-900" x-text="user.full_name"></div>
                                        <div class="text-sm text-gray-500" x-text="`@${user.username}`"></div>
                                        <div class="text-sm text-gray-500"
                                             x-text="user.location || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∑–µ–º–ª–∏'"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm text-gray-800 line-clamp-2"
                                     x-text="user.title || '–ë–µ–∑ —Ç–∏—Ç—É–ª–∞'"></div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-sm text-gray-800"
                                      x-text="user.role === 'admin' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'"></span>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex flex-wrap gap-2">
                                    <button
                                            @click="openEditModal(user)"
                                            class="bg-red-600 text-white px-3 py-1.5 text-sm rounded-lg hover:bg-red-700 transition-colors"
                                    >
                                        ‚úçÔ∏è –¢–∏—Ç—É–ª
                                    </button>
                                    <button
                                            @click="openPasswordModal(user)"
                                            class="bg-blue-600 text-white px-3 py-1.5 text-sm rounded-lg hover:bg-blue-700 transition-colors"
                                    >
                                        üîë –ü–∞—Ä–æ–ª—å
                                    </button>
                                    <button
                                            @click="openHistoryModal(user.id)"
                                            class="bg-gray-600 text-white px-3 py-1.5 text-sm rounded-lg hover:bg-gray-700 transition-colors"
                                    >
                                        üìú –ò—Å—Ç–æ—Ä–∏—è
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                    </tbody>
                </table>
            </div>

            <!-- Mobile Cards -->
            <div class="md:hidden divide-y divide-gray-200">
                <template x-for="user in filteredUsers" :key="user.id">
                    <div class="p-4 hover:bg-gray-50">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <div class="font-semibold text-gray-900 text-base" x-text="user.full_name"></div>
                                <div class="text-sm text-gray-500" x-text="`@${user.username}`"></div>
                                <div class="text-sm text-gray-500" x-text="user.location || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∑–µ–º–ª–∏'"></div>
                            </div>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded"
                                  x-text="user.role === 'admin' ? '–ê–¥–º–∏–Ω' : '–Æ–∑–µ—Ä'"></span>
                        </div>
                        <div class="text-sm text-gray-700 mb-3 line-clamp-2" x-text="user.title || '–ë–µ–∑ —Ç–∏—Ç—É–ª–∞'"></div>
                        <div class="flex flex-wrap gap-2">
                            <button
                                    @click="openEditModal(user)"
                                    class="flex-1 bg-red-600 text-white px-3 py-2 text-sm rounded-lg hover:bg-red-700 transition-colors"
                            >
                                ‚úçÔ∏è –¢–∏—Ç—É–ª
                            </button>
                            <button
                                    @click="openPasswordModal(user)"
                                    class="flex-1 bg-blue-600 text-white px-3 py-2 text-sm rounded-lg hover:bg-blue-700 transition-colors"
                            >
                                üîë –ü–∞—Ä–æ–ª—å
                            </button>
                            <button
                                    @click="openHistoryModal(user.id)"
                                    class="w-full bg-gray-600 text-white px-3 py-2 text-sm rounded-lg hover:bg-gray-700 transition-colors"
                            >
                                üìú –ò—Å—Ç–æ—Ä–∏—è
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- Edit Title Modal -->
    <div x-show="showEditModal" x-transition
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
         @click="showEditModal = false">
        <div class="bg-white rounded-2xl p-4 md:p-8 max-w-2xl w-full card-shadow max-h-[90vh] overflow-y-auto"
             @click.stop>
            <h3 class="imperial-font text-2xl md:text-3xl font-bold text-red-800 text-center mb-4 md:mb-6">
                ‚öîÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¢–∏—Ç—É–ª–∞ ‚öîÔ∏è
            </h3>
            <div class="space-y-4 md:space-y-6">
                <div>
                    <label class="block text-base md:text-lg font-semibold text-gray-800 mb-2 md:mb-3 imperial-font">
                        üëë –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                    </label>
                    <p class="text-sm md:text-base text-gray-800" x-text="selectedUser?.full_name"></p>
                    <p class="text-xs md:text-sm text-gray-500" x-text="`@${selectedUser?.username}`"></p>
                </div>
                <div>
                    <label class="block text-base md:text-lg font-semibold text-gray-800 mb-2 md:mb-3 imperial-font">
                        üìú –¢–µ–∫—É—â–∏–π —Ç–∏—Ç—É–ª
                    </label>
                    <p class="text-sm md:text-base text-gray-800" x-text="selectedUser?.title || '–ë–µ–∑ —Ç–∏—Ç—É–ª–∞'"></p>
                </div>
                <div>
                    <label class="block text-base md:text-lg font-semibold text-gray-800 mb-2 md:mb-3 imperial-font">
                        üèÜ –ù–æ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
                    </label>
                    <textarea
                            x-model="editForm.achievements"
                            rows="3"
                            placeholder="–û–ø–∏—à–∏—Ç–µ –Ω–æ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è..."
                            class="w-full px-3 md:px-4 py-2 md:py-3 text-sm md:text-base border-2 border-gray-300 rounded-lg focus:border-red-500 focus:outline-none transition-colors resize-none"
                    ></textarea>
                </div>
                <div>
                    <label class="block text-base md:text-lg font-semibold text-gray-800 mb-2 md:mb-3 imperial-font">
                        üìñ –ù–æ–≤—ã–µ –∏—Å—Ç–æ—Ä–∏–∏
                    </label>
                    <textarea
                            x-model="editForm.stories"
                            rows="3"
                            placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –Ω–æ–≤—ã–µ –∏—Å—Ç–æ—Ä–∏–∏..."
                            class="w-full px-3 md:px-4 py-2 md:py-3 text-sm md:text-base border-2 border-gray-300 rounded-lg focus:border-red-500 focus:outline-none transition-colors resize-none"
                    ></textarea>
                </div>
                <div>
                    <label class="block text-base md:text-lg font-semibold text-gray-800 mb-2 md:mb-3 imperial-font">
                        üëë –ù–æ–≤—ã–π —Ç–∏—Ç—É–ª
                    </label>
                    <input
                            x-model="editForm.title"
                            type="text"
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–∏—Ç—É–ª..."
                            class="w-full px-3 md:px-4 py-2 md:py-3 text-sm md:text-base border-2 border-gray-300 rounded-lg focus:border-red-500 focus:outline-none transition-colors"
                    >
                </div>
                <div class="flex items-center">
                    <input
                            x-model="editForm.useAI"
                            type="checkbox"
                            id="useAI"
                            class="h-4 w-4 md:h-5 md:w-5 text-red-600 focus:ring-red-500 border-gray-300 rounded"
                    >
                    <label for="useAI" class="ml-2 text-sm md:text-base text-gray-800">
                        –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å AI
                    </label>
                </div>
                <div class="flex flex-col sm:flex-row justify-center gap-2 md:gap-4">
                    <button
                            @click="generateAITitle"
                            :disabled="isLoading || !editForm.useAI"
                            class="bg-purple-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-lg font-bold text-sm md:text-base hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <span x-show="!isLoading">ü§ñ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</span>
                        <span x-show="isLoading" class="flex items-center justify-center">
                                <svg class="animate-spin h-4 w-4 md:h-5 md:w-5 mr-2" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                            stroke-width="4" fill="none"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                          d="m4 12a8 8 0 0 1 8-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 0 1 4 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...
                            </span>
                    </button>
                    <button
                            @click="saveTitle"
                            :disabled="isLoading"
                            class="bg-red-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-lg font-bold text-sm md:text-base hover:bg-red-700 transition-colors disabled:opacity-50"
                    >
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                    <button
                            @click="showEditModal = false"
                            class="bg-gray-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-lg font-bold text-sm md:text-base hover:bg-gray-700 transition-colors"
                    >
                        –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
                <div x-show="error"
                     class="bg-red-100 border border-red-400 text-red-700 px-3 md:px-4 py-2 md:py-3 rounded-lg text-center text-sm md:text-base">
                    <p x-text="error"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div x-show="showPasswordModal" x-transition
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
         @click="showPasswordModal = false">
        <div class="bg-white rounded-2xl p-4 md:p-8 max-w-md w-full card-shadow" @click.stop>
            <h3 class="imperial-font text-2xl md:text-3xl font-bold text-blue-800 text-center mb-4 md:mb-6">
                üîë –°–º–µ–Ω–∞ –ü–∞—Ä–æ–ª—è
            </h3>
            <div class="space-y-4 md:space-y-6">
                <div>
                    <label class="block text-base md:text-lg font-semibold text-gray-800 mb-2 md:mb-3">
                        üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                    </label>
                    <p class="text-sm md:text-base text-gray-800" x-text="selectedUser?.full_name"></p>
                    <p class="text-xs md:text-sm text-gray-500" x-text="`@${selectedUser?.username}`"></p>
                </div>
                <div>
                    <label class="block text-base md:text-lg font-semibold text-gray-800 mb-2 md:mb-3">
                        üîí –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å
                    </label>
                    <input
                            x-model="passwordForm.newPassword"
                            type="password"
                            placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤"
                            class="w-full px-3 md:px-4 py-2 md:py-3 text-sm md:text-base border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
                    >
                </div>
                <div>
                    <label class="block text-base md:text-lg font-semibold text-gray-800 mb-2 md:mb-3">
                        üîí –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å
                    </label>
                    <input
                            x-model="passwordForm.confirmPassword"
                            type="password"
                            placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
                            class="w-full px-3 md:px-4 py-2 md:py-3 text-sm md:text-base border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
                    >
                </div>
                <div class="flex flex-col sm:flex-row justify-center gap-2 md:gap-4">
                    <button
                            @click="changePassword"
                            :disabled="isLoading"
                            class="bg-blue-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-lg font-bold text-sm md:text-base hover:bg-blue-700 transition-colors disabled:opacity-50"
                    >
                        <span x-show="!isLoading">üíæ –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</span>
                        <span x-show="isLoading" class="flex items-center justify-center">
                                <svg class="animate-spin h-4 w-4 md:h-5 md:w-5 mr-2" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                            stroke-width="4" fill="none"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                          d="m4 12a8 8 0 0 1 8-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 0 1 4 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...
                            </span>
                    </button>
                    <button
                            @click="showPasswordModal = false"
                            class="bg-gray-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-lg font-bold text-sm md:text-base hover:bg-gray-700 transition-colors"
                    >
                        –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
                <div x-show="passwordError"
                     class="bg-red-100 border border-red-400 text-red-700 px-3 md:px-4 py-2 md:py-3 rounded-lg text-center text-sm md:text-base">
                    <p x-text="passwordError"></p>
                </div>
                <div x-show="passwordSuccess"
                     class="bg-green-100 border border-green-400 text-green-700 px-3 md:px-4 py-2 md:py-3 rounded-lg text-center text-sm md:text-base">
                    <p x-text="passwordSuccess"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Title History Modal -->
    <div x-show="showHistoryModal" x-transition
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
         @click="showHistoryModal = false">
        <div class="bg-white rounded-2xl p-4 md:p-8 max-w-3xl w-full card-shadow overflow-y-auto max-h-[90vh]"
             @click.stop>
            <h3 class="imperial-font text-2xl md:text-3xl font-bold text-red-800 text-center mb-4 md:mb-6">
                üìú –ò—Å—Ç–æ—Ä–∏—è –¢–∏—Ç—É–ª–æ–≤
            </h3>
            <div x-show="historyLoading" class="text-center py-4">
                <div class="inline-flex items-center text-gray-800 text-base md:text-lg">
                    <svg class="animate-spin h-5 w-5 md:h-6 md:w-6 mr-3" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"
                                fill="none"></circle>
                        <path class="opacity-75" fill="currentColor"
                              d="m4 12a8 8 0 0 1 8-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 0 1 4 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    –ó–∞–≥—Ä—É–∑–∫–∞...
                </div>
            </div>
            <div x-show="!historyLoading && history.length === 0"
                 class="text-center text-gray-800 text-sm md:text-base">
                <p>–ò—Å—Ç–æ—Ä–∏—è —Ç–∏—Ç—É–ª–æ–≤ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</p>
            </div>
            <div x-show="!historyLoading && history.length > 0" class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                    <tr>
                        <th class="px-2 md:px-4 py-2 md:py-3 text-left text-xs md:text-sm font-semibold text-gray-900">
                            –î–∞—Ç–∞
                        </th>
                        <th class="px-2 md:px-4 py-2 md:py-3 text-left text-xs md:text-sm font-semibold text-gray-900">
                            –°—Ç–∞—Ä—ã–π
                        </th>
                        <th class="px-2 md:px-4 py-2 md:py-3 text-left text-xs md:text-sm font-semibold text-gray-900">
                            –ù–æ–≤—ã–π
                        </th>
                        <th class="px-2 md:px-4 py-2 md:py-3 text-left text-xs md:text-sm font-semibold text-gray-900 hidden md:table-cell">
                            –ü—Ä–∏—á–∏–Ω–∞
                        </th>
                        <th class="px-2 md:px-4 py-2 md:py-3 text-left text-xs md:text-sm font-semibold text-gray-900 hidden md:table-cell">
                            –ö–µ–º
                        </th>
                    </tr>
                    </thead>
                    <tbody>
                    <template x-for="entry in history" :key="entry.id">
                        <tr class="border-t border-gray-200">
                            <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm"
                                x-text="formatDate(entry.created_at)"></td>
                            <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm truncate max-w-xs"
                                x-text="entry.old_title || '–ë–µ–∑ —Ç–∏—Ç—É–ª–∞'"></td>
                            <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm truncate max-w-xs"
                                x-text="entry.new_title"></td>
                            <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm hidden md:table-cell"
                                x-text="entry.reason"></td>
                            <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm hidden md:table-cell"
                                x-text="entry.modified_by_username"></td>
                        </tr>
                    </template>
                    </tbody>
                </table>
            </div>
            <div class="text-center mt-4 md:mt-6">
                <button
                        @click="showHistoryModal = false"
                        class="bg-gray-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-lg font-bold text-sm md:text-base hover:bg-gray-700 transition-colors"
                >
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    </div>
    <!-- Footer -->
    <footer class="text-center text-white/80 mt-8 md:mt-12">
        <p class="text-base md:text-lg imperial-font">
            üçæ –í–æ —Å–ª–∞–≤—É Party Kaiser –∏ –ö–æ–Ω—å—è—á–Ω—ã—Ö –†—ã—Ü–∞—Ä–µ–π üçæ
        </p>
        <p class="text-xs md:text-sm mt-2">
            Powered by Party Kaiser AI
        </p>
    </footer>
</div>
<script>
    function adminPanel() {
        return {
            users: [],
            filteredUsers: [],
            searchTerm: '',
            filterRole: 'all',
            isAuthorized: false,
            loading: true,
            isLoading: false,
            error: '',
            showEditModal: false,
            showPasswordModal: false,
            showHistoryModal: false,
            selectedUser: null,
            editForm: {
                achievements: '',
                stories: '',
                title: '',
                useAI: false
            },
            passwordForm: {
                newPassword: '',
                confirmPassword: ''
            },
            passwordError: '',
            passwordSuccess: '',
            history: [],
            historyLoading: false,

            async init() {
                this.loading = true;
                this.error = '';
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        this.isAuthorized = false;
                        this.loading = false;
                        return;
                    }

                    const response = await fetch('/api/admin/users', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.status === 403 || response.status === 401) {
                        this.isAuthorized = false;
                        this.loading = false;
                        return;
                    }

                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                    }

                    this.users = data;
                    this.filteredUsers = [...data];
                    this.isAuthorized = true;
                    this.filterUsers();
                } catch (error) {
                    this.error = error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞';
                    this.isAuthorized = false;
                } finally {
                    this.loading = false;
                }
            },

            filterUsers() {
                const term = this.searchTerm.toLowerCase();
                this.filteredUsers = this.users.filter(user => {
                    const matchesSearch =
                        user.full_name.toLowerCase().includes(term) ||
                        user.username.toLowerCase().includes(term) ||
                        (user.title && user.title.toLowerCase().includes(term));
                    const matchesRole =
                        this.filterRole === 'all' ||
                        user.role === this.filterRole;
                    return matchesSearch && matchesRole;
                });
            },

            openEditModal(user) {
                this.selectedUser = user;
                this.editForm = {
                    achievements: '',
                    stories: '',
                    title: user.title || '',
                    useAI: false
                };
                this.error = '';
                this.showEditModal = true;
            },

            openPasswordModal(user) {
                this.selectedUser = user;
                this.passwordForm = {
                    newPassword: '',
                    confirmPassword: ''
                };
                this.passwordError = '';
                this.passwordSuccess = '';
                this.showPasswordModal = true;
            },

            async changePassword() {
                this.passwordError = '';
                this.passwordSuccess = '';

                if (!this.passwordForm.newPassword || this.passwordForm.newPassword.length < 6) {
                    this.passwordError = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
                    return;
                }

                if (this.passwordForm.newPassword !== this.passwordForm.confirmPassword) {
                    this.passwordError = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
                    return;
                }

                this.isLoading = true;

                try {
                    const response = await fetch(`/api/admin/users/${this.selectedUser.id}/password`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            newPassword: this.passwordForm.newPassword
                        })
                    });

                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è');
                    }

                    this.passwordSuccess = '–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω!';
                    this.passwordForm = {
                        newPassword: '',
                        confirmPassword: ''
                    };

                    setTimeout(() => {
                        this.showPasswordModal = false;
                        this.passwordSuccess = '';
                    }, 2000);
                } catch (error) {
                    this.passwordError = error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è';
                } finally {
                    this.isLoading = false;
                }
            },

            async generateAITitle() {
                if (!this.editForm.useAI || !this.selectedUser) return;

                this.isLoading = true;
                this.error = '';

                try {
                    const response = await fetch(`/api/admin/users/${this.selectedUser.id}/title`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            useAI: true,
                            achievements: this.editForm.achievements,
                            stories: this.editForm.stories
                        })
                    });

                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–∏—Ç—É–ª–∞');
                    }

                    this.editForm.title = data.newTitle;
                } catch (error) {
                    this.error = error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–∏—Ç—É–ª–∞';
                } finally {
                    this.isLoading = false;
                }
            },

            async saveTitle() {
                if (!this.selectedUser) return;

                this.isLoading = true;
                this.error = '';

                try {
                    const response = await fetch(`/api/admin/users/${this.selectedUser.id}/title`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            title: this.editForm.title,
                            useAI: false
                        })
                    });

                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∏—Ç—É–ª–∞');
                    }

                    this.users = this.users.map(u =>
                        u.id === this.selectedUser.id
                            ? {...u, title: data.newTitle}
                            : u
                    );
                    this.filterUsers();
                    this.showEditModal = false;
                } catch (error) {
                    this.error = error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç–∏—Ç—É–ª–∞';
                } finally {
                    this.isLoading = false;
                }
            },

            async openHistoryModal(userId) {
                this.historyLoading = true;
                this.history = [];
                this.error = '';
                this.showHistoryModal = true;

                try {
                    const response = await fetch(`/api/admin/title-history/${userId}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏');
                    }

                    this.history = data;
                } catch (error) {
                    this.error = error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞';
                } finally {
                    this.historyLoading = false;
                }
            },

            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('ru-RU', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        }
    }
</script>
</body>

</html>