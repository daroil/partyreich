<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –ü–∞—Ç–∏-–†–∞–π—Ö</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      fontFamily: {
        gothic: ['"HelmswaldPost"', 'serif'],
      }
    }
  }
}
</script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<style>
@font-face {
  font-family: 'HelmswaldPost';
  src: url('/helmswald-post-font/HelmswaldPost-1r2M.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}
@font-face {
  font-family: 'Groundage';
  src: url('/groundage/Groundage-Regular.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}
.gothic-font {
  font-family: 'Groundage', serif;
}
.gothic-latin-font {
  font-family: 'HelmswaldPost', serif;
}
.modern-font {
  font-family: 'Inter', sans-serif;
}
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
</style>
</head>
<body class="modern-font bg-white text-gray-800 min-h-screen">
<div x-data="adminPanel()" x-init="init()" class="container mx-auto px-4 py-8">
  <!-- Header -->
  <div class="text-center mb-8 justify-center flex flex-col">
    <img src="img/partyreich.png" class="mb-3 max-w-sm md:max-w-lg tracking-wide self-center">
    <p class="text-2xl mt-5 gothic-font text-gray-700">
      –ê–¥–º–∏–Ω-–ü–∞–Ω–µ–ª—å –ü–∞—Ç–∏-–†–∞–π—Ö–∞
    </p>
    <p class="text-2xl gothic-font text-gray-600 mt-2 tracking-wide">
      –í–æ —Å–ª–∞–≤—É Party Kaiser –∏ –ö–æ–Ω—å—è—á–Ω—ã—Ö –†—ã—Ü–∞—Ä–µ–π
    </p>
    <!-- Navigation -->
    <div class="mt-6 gap-1 md:flex-row flex-col flex justify-center">
      <a href="/"
         class="bg-gray-100 text-gray-800 px-4 py-2 rounded border border-gray-300 hover:bg-gray-200 transition-colors text-2xl gothic-font">
        –ì–ª–∞–≤–Ω–∞—è
      </a>
      <a href="/profile"
         class="bg-gray-100 text-gray-800 px-4 py-2 rounded border border-gray-300 hover:bg-gray-200 transition-colors text-2xl gothic-font">
        –ü—Ä–æ—Ñ–∏–ª—å
      </a>
      <a href="/hall-of-fame"
         class="bg-gray-100 text-gray-800 px-4 py-2 rounded border border-gray-300 hover:bg-gray-200 transition-colors text-2xl gothic-font">
        –ó–∞–ª –°–ª–∞–≤—ã
      </a>
    </div>
  </div>

  <!-- Access Denied -->
  <div x-show="!isAuthorized && !loading" class="max-w-4xl mx-auto bg-gray-50 border border-gray-300 rounded shadow-md overflow-hidden">
    <div class="bg-gray-800 p-5">
      <h2 class="gothic-latin-font text-4xl font-normal text-white text-center tracking-wide">
        üö´ –î–æ—Å—Ç—É–ø –ó–∞–ø—Ä–µ—â—ë–Ω
      </h2>
    </div>
    <div class="p-6 text-center">
      <p class="text-2xl gothic-font text-gray-800 mb-4">
        –¢–æ–ª—å–∫–æ Party Kaiser –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —ç—Ç–æ–π –ø–∞–Ω–µ–ª–∏.
      </p>
      <a href="/profile"
         class="bg-gray-900 text-white px-6 py-3 rounded gothic-font tracking-wide hover:bg-black transition-colors">
        –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ü—Ä–æ—Ñ–∏–ª—å
      </a>
    </div>
  </div>

  <!-- Loading -->
  <div x-show="loading" class="text-center py-12">
    <div class="inline-flex items-center text-gray-800 text-2xl">
      <svg class="animate-spin h-6 w-6 mr-3" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
        <path class="opacity-75" fill="currentColor"
          d="m4 12a8 8 0 0 1 8-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 0 1 4 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      –ó–∞–≥—Ä—É–∑–∫–∞...
    </div>
  </div>

  <!-- Admin Content -->
  <div x-show="isAuthorized && !loading" class="space-y-8">

    <!-- Stats Overview -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="flex flex-col gap-2 items-center bg-gray-100 border border-gray-300 rounded p-4 text-center">
        <img src="img/cup.png" class="max-w-8">
        <div class="text-2xl font-bold gothic-font" x-text="users.length"></div>
        <div class="text-gray-600 gothic-font">–í—Å–µ–≥–æ</div>
      </div>
      <div class="flex flex-col gap-2 items-center bg-gray-100 border border-gray-300 rounded p-4 text-center">
        <img src="img/candle.png" class="max-w-8">
        <div class="text-2xl font-bold gothic-font" x-text="users.filter(u => u.oath_taken).length"></div>
        <div class="text-gray-600 gothic-font">–ü–æ–¥–¥–∞–Ω–Ω—ã—Ö</div>
      </div>
      <div class="flex flex-col gap-2 items-center bg-gray-100 border border-gray-300 rounded p-4 text-center">
        <img src="img/crown.png" class="max-w-8">
        <div class="text-2xl font-bold gothic-font" x-text="users.filter(u => u.role === 'admin').length"></div>
        <div class="text-gray-600 gothic-font">–ê–¥–º–∏–Ω–æ–≤</div>
      </div>
      <div class="flex flex-col gap-2 items-center bg-gray-100 border border-gray-300 rounded p-4 text-center">
        <img src="img/scroll.png" class="max-w-8">
        <div class="text-2xl font-bold gothic-font" x-text="users.filter(u => u.title).length"></div>
        <div class="text-gray-600 gothic-font">–¢–∏—Ç—É–ª–æ–≤</div>
      </div>
    </div>

    <!-- Search & Filter -->
    <div class="max-w-4xl mx-auto bg-gray-50 border border-gray-300 rounded shadow-md overflow-hidden">
      <div class="p-5 space-y-4">
        <input
          x-model="searchTerm"
          @input="filterUsers"
          type="text"
          placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, —é–∑–µ—Ä–Ω–µ–π–º—É –∏–ª–∏ —Ç–∏—Ç—É–ª—É..."
          class="w-full px-4 py-3 border border-gray-400 rounded bg-white focus:border-gray-700 focus:outline-none focus:ring-1 focus:ring-gray-600"
        >
        <div class="flex flex-col sm:flex-row gap-3">
          <select
            x-model="filterRole"
            @change="filterUsers"
            class="flex-1 px-4 py-3 border border-gray-400 rounded bg-white focus:border-gray-700 focus:outline-none focus:ring-1 focus:ring-gray-600"
          >
            <option value="all">–í—Å–µ —Ä–æ–ª–∏</option>
            <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</option>
            <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
          </select>
          <div class="flex items-center text-xl gothic-font text-gray-700">
            <span x-text="filteredUsers.length"></span> –Ω–∞–π–¥–µ–Ω–æ
          </div>
        </div>
      </div>
    </div>

    <!-- Users Table -->
    <div class="max-w-4xl mx-auto bg-gray-50 border border-gray-300 rounded shadow-md overflow-hidden">
      <div class="bg-gray-800 p-5">
        <h2 class="gothic-font text-3xl font-normal text-white text-center tracking-wide">
          –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–æ–¥–¥–∞–Ω–Ω—ã–º–∏
        </h2>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-center">
          <thead class="bg-gray-200">
            <tr>
              <th class="px-4 py-3 text-left text-gray-800 gothic-font">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
              <th class="px-4 py-3 text-left text-gray-800 gothic-font">–¢–∏—Ç—É–ª</th>
              <th class="px-4 py-3 text-left text-gray-800 gothic-font">–†–æ–ª—å</th>
              <th class="px-4 py-3 text-left text-gray-800 gothic-font">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="user in filteredUsers" :key="user.id">
              <tr class="border-t border-gray-300 hover:bg-gray-100">
                <td class="px-4 py-3 text-left">
                  <div class="font-semibold gothic-font" x-text="user.full_name"></div>
                  <div class="text-gray-600" x-text="`@${user.username}`"></div>
                  <div class="text-gray-500 text-sm" x-text="user.location || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∑–µ–º–ª–∏'"></div>
                </td>
                <td class="px-4 py-3 text-left gothic-font "
                    x-text="user.title || '–ë–µ–∑ —Ç–∏—Ç—É–ª–∞'"></td>
                <td class="px-4 py-3 text-left">
                  <span x-text="user.role === 'admin' ? '–ê–¥–º–∏–Ω' : '–Æ–∑–µ—Ä'"
                        class="px-2 py-1 text-xs rounded bg-gray-200 text-gray-700"></span>
                </td>
                <td class="px-4 py-3">
                  <div class="flex flex-wrap gap-1">
                    <button
                      @click="openEditModal(user)"
                      class="flex flex-1 justify-center bg-gray-900 text-white px-3 py-1.5 rounded gothic-font text-sm hover:bg-black transition-colors">
                      –¢–∏—Ç—É–ª
                    </button>
                    <button
                      @click="openPasswordModal(user)"
                      class="flex flex-1 justify-center bg-blue-600 text-white px-3 py-1.5 rounded gothic-font text-sm hover:bg-blue-700 transition-colors">
                      –ü–∞—Ä–æ–ª—å
                    </button>
                    <button
                      @click="openHistoryModal(user.id)"
                      class="flex flex-1 justify-center bg-gray-600 text-white px-3 py-1.5 rounded gothic-font text-sm hover:bg-gray-700 transition-colors">
                      –ò—Å—Ç–æ—Ä–∏—è
                    </button>
                  </div>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Edit Title Modal -->
  <div x-show="showEditModal" x-transition
       class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4"
       @click="showEditModal = false">
    <div class="bg-white border-2 border-gray-700 rounded p-6 max-w-2xl w-full shadow-xl" @click.stop>
      <h3 class="gothic-font text-3xl text-gray-900 text-center mb-4">
        ‚öîÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¢–∏—Ç—É–ª–∞
      </h3>
      <div class="space-y-4">
        <div>
          <label class="block text-2xl font-medium text-gray-800 mb-2 gothic-font">
            üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
          </label>
          <p class="text-xl gothic-font" x-text="selectedUser?.full_name"></p>
          <p class="text-gray-600" x-text="`@${selectedUser?.username}`"></p>
        </div>
        <div>
          <label class="block text-2xl font-medium text-gray-800 mb-2 gothic-font">
            üìú –¢–µ–∫—É—â–∏–π —Ç–∏—Ç—É–ª
          </label>
          <p class="text-xl gothic-font" x-text="selectedUser?.title || '–ë–µ–∑ —Ç–∏—Ç—É–ª–∞'"></p>
        </div>
        <div>
          <label class="block text-2xl font-medium text-gray-800 mb-2 gothic-font">
            üèÜ –ù–æ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
          </label>
          <textarea
            x-model="editForm.achievements"
            rows="3"
            placeholder="–û–ø–∏—à–∏—Ç–µ –Ω–æ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è..."
            class="w-full px-4 py-3 border border-gray-400 rounded bg-white focus:border-gray-700 focus:outline-none focus:ring-1 focus:ring-gray-600 resize-none"
          ></textarea>
        </div>
        <div>
          <label class="block text-2xl font-medium text-gray-800 mb-2 gothic-font">
            üìñ –ù–æ–≤—ã–µ –∏—Å—Ç–æ—Ä–∏–∏
          </label>
          <textarea
            x-model="editForm.stories"
            rows="3"
            placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –Ω–æ–≤—ã–µ –∏—Å—Ç–æ—Ä–∏–∏..."
            class="w-full px-4 py-3 border border-gray-400 rounded bg-white focus:border-gray-700 focus:outline-none focus:ring-1 focus:ring-gray-600 resize-none"
          ></textarea>
        </div>
        <div>
          <label class="block text-2xl font-medium text-gray-800 mb-2 gothic-font">
            üëë –ù–æ–≤—ã–π —Ç–∏—Ç—É–ª
          </label>
          <input
            x-model="editForm.title"
            type="text"
            placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–∏—Ç—É–ª..."
            class="w-full px-4 py-3 border border-gray-400 rounded bg-white focus:border-gray-700 focus:outline-none focus:ring-1 focus:ring-gray-600"
          >
        </div>
        <div class="flex items-center">
          <input
            x-model="editForm.useAI"
            type="checkbox"
            id="useAI"
            class="h-5 w-5 text-gray-700 focus:ring-gray-600 border-gray-400 rounded"
          >
          <label for="useAI" class="ml-2 text-xl text-gray-800 gothic-font">
            –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å AI
          </label>
        </div>
        <div x-show="error" class="bg-red-50 border border-red-300 text-red-700 px-4 py-3 rounded text-center text-xl">
          <p x-text="error"></p>
        </div>
        <div class="flex flex-col sm:flex-row gap-3 justify-center pt-2">
          <button
            @click="generateAITitle"
            :disabled="isLoading || !editForm.useAI"
            class="bg-purple-600 text-white px-5 py-2.5 rounded gothic-font text-2xl hover:bg-purple-700 transition-colors disabled:opacity-50"
          >
            <span x-show="!isLoading">ü§ñ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</span>
            <span x-show="isLoading" class="flex items-center justify-center">
              <svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                <path class="opacity-75" fill="currentColor"
                  d="m4 12a8 8 0 0 1 8-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 0 1 4 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...
            </span>
          </button>
          <button
            @click="saveTitle"
            :disabled="isLoading"
            class="bg-gray-900 text-white px-5 py-2.5 rounded gothic-font text-2xl hover:bg-black transition-colors disabled:opacity-50"
          >
            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
          </button>
          <button
            @click="showEditModal = false"
            class="bg-gray-600 text-white px-5 py-2.5 rounded gothic-font text-2xl hover:bg-gray-700 transition-colors"
          >
            –û—Ç–º–µ–Ω–∞
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div x-show="showPasswordModal" x-transition
       class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4"
       @click="showPasswordModal = false">
    <div class="bg-white border-2 border-gray-700 rounded p-6 max-w-md w-full shadow-xl" @click.stop>
      <h3 class="gothic-font text-3xl text-gray-900 text-center mb-4">
        üîë –°–º–µ–Ω–∞ –ü–∞—Ä–æ–ª—è
      </h3>
      <div class="space-y-4">
        <div>
          <label class="block text-2xl font-medium text-gray-800 mb-2 gothic-font">
            üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
          </label>
          <p class="text-xl gothic-font" x-text="selectedUser?.full_name"></p>
          <p class="text-gray-600" x-text="`@${selectedUser?.username}`"></p>
        </div>
        <div>
          <label class="block text-2xl font-medium text-gray-800 mb-2 gothic-font">
            üîí –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å
          </label>
          <input
            x-model="passwordForm.newPassword"
            type="password"
            placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤"
            class="w-full px-4 py-3 border border-gray-400 rounded bg-white focus:border-gray-700 focus:outline-none focus:ring-1 focus:ring-gray-600"
          >
        </div>
        <div>
          <label class="block text-2xl font-medium text-gray-800 mb-2 gothic-font">
            üîí –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å
          </label>
          <input
            x-model="passwordForm.confirmPassword"
            type="password"
            placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
            class="w-full px-4 py-3 border border-gray-400 rounded bg-white focus:border-gray-700 focus:outline-none focus:ring-1 focus:ring-gray-600"
          >
        </div>
        <div x-show="passwordError" class="bg-red-50 border border-red-300 text-red-700 px-4 py-3 rounded text-center text-xl">
          <p x-text="passwordError"></p>
        </div>
        <div x-show="passwordSuccess" class="bg-green-50 border border-green-300 text-green-700 px-4 py-3 rounded text-center text-xl">
          <p x-text="passwordSuccess"></p>
        </div>
        <div class="flex flex-col sm:flex-row gap-3 justify-center pt-2">
          <button
            @click="changePassword"
            :disabled="isLoading"
            class="bg-blue-600 text-white px-5 py-2.5 rounded gothic-font text-2xl hover:bg-blue-700 transition-colors disabled:opacity-50"
          >
            <span x-show="!isLoading">üíæ –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</span>
            <span x-show="isLoading" class="flex items-center justify-center">
              <svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                <path class="opacity-75" fill="currentColor"
                  d="m4 12a8 8 0 0 1 8-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 0 1 4 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...
            </span>
          </button>
          <button
            @click="showPasswordModal = false"
            class="bg-gray-600 text-white px-5 py-2.5 rounded gothic-font text-2xl hover:bg-gray-700 transition-colors"
          >
            –û—Ç–º–µ–Ω–∞
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Title History Modal -->
  <div x-show="showHistoryModal" x-transition
       class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4"
       @click="showHistoryModal = false">
    <div class="bg-white border-2 border-gray-700 rounded p-6 max-w-3xl w-full shadow-xl max-h-[80vh] overflow-y-auto" @click.stop>
      <h3 class="gothic-font text-3xl text-gray-900 text-center mb-4">
        –ò—Å—Ç–æ—Ä–∏—è –¢–∏—Ç—É–ª–æ–≤
      </h3>
      <div x-show="historyLoading" class="text-center py-6">
        <div class="inline-flex items-center text-gray-800 text-2xl">
          <svg class="animate-spin h-6 w-6 mr-3" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
            <path class="opacity-75" fill="currentColor"
              d="m4 12a8 8 0 0 1 8-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 0 1 4 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          –ó–∞–≥—Ä—É–∑–∫–∞...
        </div>
      </div>
      <div x-show="!historyLoading && history.length === 0" class="text-center text-xl gothic-font text-gray-700 py-4">
        <p>–ò—Å—Ç–æ—Ä–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</p>
      </div>
      <div x-show="!historyLoading && history.length > 0" class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-3 py-2 text-left gothic-font">–î–∞—Ç–∞</th>
              <th class="px-3 py-2 text-left gothic-font">–°—Ç–∞—Ä—ã–π</th>
              <th class="px-3 py-2 text-left gothic-font">–ù–æ–≤—ã–π</th>
              <th class="px-3 py-2 text-left gothic-font hidden md:table-cell">–ü—Ä–∏—á–∏–Ω–∞</th>
              <th class="px-3 py-2 text-left gothic-font hidden md:table-cell">–ö–µ–º</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="entry in history" :key="entry.id">
              <tr class="border-t border-gray-200">
                <td class="px-3 py-2 text-gray-800" x-text="formatDate(entry.created_at)"></td>
                <td class="px-3 py-2 text-gray-800 truncate max-w-xs"
                    x-text="entry.old_title || '–ë–µ–∑ —Ç–∏—Ç—É–ª–∞'"></td>
                <td class="px-3 py-2 text-gray-800 truncate max-w-xs"
                    x-text="entry.new_title"></td>
                <td class="px-3 py-2 text-gray-800 hidden md:table-cell"
                    x-text="entry.reason"></td>
                <td class="px-3 py-2 text-gray-800 hidden md:table-cell"
                    x-text="entry.modified_by_username"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
      <div class="text-center mt-6">
        <button
          @click="showHistoryModal = false"
          class="bg-gray-600 text-white px-5 py-2.5 rounded gothic-font text-2xl hover:bg-gray-700 transition-colors"
        >
          –ó–∞–∫—Ä—ã—Ç—å
        </button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="text-center text-gray-600 mt-12 pb-6 text-2xl">
    <p class="gothic-font tracking-wide">
      –í–æ —Å–ª–∞–≤—É –ö–æ–Ω—å—è—á–Ω—ã—Ö –†—ã—Ü–∞—Ä–µ–π –∏ —Å–≤—è—â–µ–Ω–Ω–æ–≥–æ –ö–æ–Ω—å—è—á–Ω–æ–≥–æ –ú–µ—á–∞
    </p>
    <p class="mt-4 gothic-font">
      Powered by Party Kaiser AI
    </p>
  </footer>
</div>

<script>
function adminPanel() {
  return {
    users: [],
    filteredUsers: [],
    searchTerm: '',
    filterRole: 'all',
    isAuthorized: false,
    loading: true,
    isLoading: false,
    error: '',
    showEditModal: false,
    showPasswordModal: false,
    showHistoryModal: false,
    selectedUser: null,
    editForm: {
      achievements: '',
      stories: '',
      title: '',
      useAI: false
    },
    passwordForm: {
      newPassword: '',
      confirmPassword: ''
    },
    passwordError: '',
    passwordSuccess: '',
    history: [],
    historyLoading: false,

    async init() {
      this.loading = true;
      this.error = '';
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          this.isAuthorized = false;
          this.loading = false;
          return;
        }
        const response = await fetch('/api/admin/users', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.status === 403 || response.status === 401) {
          this.isAuthorized = false;
          this.loading = false;
          return;
        }
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        this.users = data;
        this.filteredUsers = [...data];
        this.isAuthorized = true;
        this.filterUsers();
      } catch (error) {
        this.error = error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞';
        this.isAuthorized = false;
      } finally {
        this.loading = false;
      }
    },

    filterUsers() {
      const term = this.searchTerm.toLowerCase();
      this.filteredUsers = this.users.filter(user => {
        const matchesSearch =
          user.full_name.toLowerCase().includes(term) ||
          user.username.toLowerCase().includes(term) ||
          (user.title && user.title.toLowerCase().includes(term));
        const matchesRole = this.filterRole === 'all' || user.role === this.filterRole;
        return matchesSearch && matchesRole;
      });
    },

    openEditModal(user) {
      this.selectedUser = user;
      this.editForm = {
        achievements: '',
        stories: '',
        title: user.title || '',
        useAI: false
      };
      this.error = '';
      this.showEditModal = true;
    },

    openPasswordModal(user) {
      this.selectedUser = user;
      this.passwordForm = { newPassword: '', confirmPassword: '' };
      this.passwordError = '';
      this.passwordSuccess = '';
      this.showPasswordModal = true;
    },

    async changePassword() {
      this.passwordError = '';
      this.passwordSuccess = '';
      if (!this.passwordForm.newPassword || this.passwordForm.newPassword.length < 6) {
        this.passwordError = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
        return;
      }
      if (this.passwordForm.newPassword !== this.passwordForm.confirmPassword) {
        this.passwordError = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
        return;
      }

      this.isLoading = true;
      try {
        const response = await fetch(`/api/admin/users/${this.selectedUser.id}/password`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify({ newPassword: this.passwordForm.newPassword })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è');
        this.passwordSuccess = '–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω!';
        setTimeout(() => {
          this.showPasswordModal = false;
          this.passwordSuccess = '';
        }, 2000);
      } catch (error) {
        this.passwordError = error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è';
      } finally {
        this.isLoading = false;
      }
    },

    async generateAITitle() {
      if (!this.editForm.useAI || !this.selectedUser) return;
      this.isLoading = true;
      this.error = '';
      try {
        const response = await fetch(`/api/admin/users/${this.selectedUser.id}/title`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify({
            useAI: true,
            achievements: this.editForm.achievements,
            stories: this.editForm.stories
          })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–∏—Ç—É–ª–∞');
        this.editForm.title = data.newTitle;
      } catch (error) {
        this.error = error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–∏—Ç—É–ª–∞';
      } finally {
        this.isLoading = false;
      }
    },

    async saveTitle() {
      if (!this.selectedUser) return;
      this.isLoading = true;
      this.error = '';
      try {
        const response = await fetch(`/api/admin/users/${this.selectedUser.id}/title`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify({ title: this.editForm.title, useAI: false })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∏—Ç—É–ª–∞');
        this.users = this.users.map(u => u.id === this.selectedUser.id ? {...u, title: data.newTitle} : u);
        this.filterUsers();
        this.showEditModal = false;
      } catch (error) {
        this.error = error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç–∏—Ç—É–ª–∞';
      } finally {
        this.isLoading = false;
      }
    },

    async openHistoryModal(userId) {
      this.historyLoading = true;
      this.history = [];
      this.error = '';
      this.showHistoryModal = true;
      try {
        const response = await fetch(`/api/admin/title-history/${userId}`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏');
        this.history = data;
      } catch (error) {
        this.error = error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞';
      } finally {
        this.historyLoading = false;
      }
    },

    formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('ru-RU', {
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
    }
  }
}
</script>
</body>
</html>